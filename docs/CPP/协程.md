# 协程

## 什么是协程

## 回调地狱

```cpp
#include <iostream>
#include <functional>
#include <thread>
#include <Windows.h>
class IntReader {
public:
	void BeginRead(const std::function<void(int)>& callback) {
		
		std::thread thread([callback]() {
			Sleep(1000);  // sleep 1s
			int value = 1;

			callback(value);
			});

		thread.detach();
	}
};

void PrintInt() {
	IntReader reader;
	reader.BeginRead([](int result) {
		std::cout << result << std::endl;
		});
}

int main() {
	PrintInt();
	while (1) {};

	return 0;
}
```



```cpp
#include <iostream>
#include <functional>
#include <thread>
#include <Windows.h>
class IntReader {
public:
	void BeginRead(const std::function<void(int)>& callback) {
		
		std::thread thread([callback]() {
			Sleep(1000);  // sleep 1s
			int value = 1;

			callback(value);
			});

		thread.detach();
	}
};

void PrintInt() {
	IntReader reader1;
	int total = 0;
	reader1.BeginRead([&total](int result1) {
		total = result1;

		IntReader reader2;
		reader2.BeginRead([&total](int result2) {
			total += result2;

			IntReader reader3;
			reader3.BeginRead([&total](int result3) {
				total += result3;

				std::cout << "total = " << total << std::endl;
				});
			});
	});
}

int main() {
	PrintInt();
	while (1) {};

	return 0;
}
```



## 用 C++ 协程实现异步操作

```cpp
#include <iostream>
#include <functional>
#include <thread>
#include <Windows.h>
#include <coroutine>

class IntReader {
private:
	int value_;
public:
	bool await_ready() {
		return false;
	}

	void await_suspend(std::coroutine_handle<> handle) {
		std::thread thread([this, handle]() {
			Sleep(1000);  // sleep 1s
			value_ = 1;
			handle.resume();
			});

		thread.detach();
	}

	int await_resume() {
		return value_;
	}
};

class Task {
public:
	class promise_type {
	public:
		Task get_return_object() {
			return {};
		}
		std::suspend_never initial_suspend() {
			return {};
		}
		std::suspend_never final_suspend() noexcept {
			return {};
		}
		void unhandled_exception() {}
		void return_void() {}
	};
};

Task PrintInt() {
	IntReader reader1;
	int total = co_await reader1;

	IntReader reader2;
	total += co_await reader2;

	IntReader reader3;
	total += co_await reader3;

	std::cout << total << std::endl;
}

int main() {
	PrintInt();
	while (1) {};

	return 0;
}
```







## 参考资料

[1] [快手C++一面：线程与协程的区别？](https://www.bilibili.com/video/BV1541xYnEsy/?spm_id_from=333.788.recommend_more_video.4&vd_source=f4cc25a44af6631d6f4db023b3bb88e4)

[2] [C++20 协程，99% 的程序员都没完全搞懂！你要做那 1% 吗？ 这可能是全网C++协程讲的最好的视频](https://www.bilibili.com/video/BV1Cz9NYFE8E/?spm_id_from=333.337.search-card.all.click&vd_source=f4cc25a44af6631d6f4db023b3bb88e4)