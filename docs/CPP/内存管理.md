# 内存管理



### 1 大端序和小端序

大端序（Big-endian）和小端序（Little-endian）是计算机存储多字节数据类型（如整数、浮点数等）时使用的两种字节序。它们描述了多字节数据在内存中的存储顺序。不同的硬件架构和操作系统可能采用不同的字节序，这在跨平台通信和数据交换时可能导致问题。

-   大端序（Big-endian）： 在大端序中，数据的高位字节（最重要的字节）存储在较低的内存地址中，而数据的低位字节（最不重要的字节）存储在较高的内存地址中。换句话说，字节序是从高位到低位。例如，32位整数 `0x12345678` 在大端序中的存储顺序是：

```cpp
内存地址： 0x01 0x02 0x03 0x04
存储值  ： 0x12 0x34 0x56 0x78
```

-   小端序（Little-endian）： 在小端序中，数据的低位字节（最不重要的字节）存储在较低的内存地址中，而数据的高位字节（最重要的字节）存储在较高的内存地址中。换句话说，字节序是从低位到高位。例如，32位整数 `0x12345678` 在小端序中的存储顺序是：

```cpp
内存地址： 0x01 0x02 0x03 0x04
存储值  ： 0x78 0x56 0x34 0x12
```

在处理跨平台数据交换时，了解大端序和小端序是很重要的。为了避免字节序问题，可以使用一种通用的字节序，如网络字节序（大端序），在发送和接收数据时进行字节序转换。

![img](https://amonologue-image-bed.oss-cn-chengdu.aliyuncs.com/2025/202506052237782.jpeg)

使用 C++ 代码检查当前系统的字节序：

```cpp
#include <iostream>
void check_endianness() {
    unsigned int num = 1;
    if (*(char *)&num == 1) {
        std::cout << "系统是小端字节序 (Little Endian)" << std::endl;
    } else {
        std::cout << "系统是大端字节序 (Big Endian)" << std::endl;
    }
}
int main() {
    check_endianness();
    return 0;
}
```



### 6. malloc与free实现原理？

`malloc` 和 `free` 是 C 语言中用于在堆上分配和释放内存的标准库函数。

**malloc**

-   内存分配：`malloc` 向操作系统请求内存，根据系统平台和库实现的不同，它可以使用 `brk()` 和 `mmap()` 两种方式来从操作系统请求内存。小于128K用`brk()` 调整数据段的大小，以分配堆内存；大于128K用`mmap()` ，通过内存映射，在进程的虚拟地址空间中分配内存。
-   内存管理：`malloc` 使用一种数据结构（通常是链表或树形结构）来管理已分配和未分配的内存块。当用户请求内存时，`malloc` 首先在内存管理数据结构中查找一个合适大小的空闲内存块。如果找到合适的内存块，`malloc` 会将其从空闲列表中移除并返回给用户。如果没有找到合适的内存块，`malloc` 会向操作系统请求更多的内存。

**free**

当调用 `free` 函数释放一块内存时，`free` 首先会根据之前 `malloc` 存储的元数据获取内存块的大小和位置。然后，`free` 会将这个内存块放回到空闲内存块列表中。

为了减少内存碎片，`free` 可能会合并相邻的空闲内存块。例如，如果一个被释放的内存块和它相邻的内存块都是空闲的，`free` 可以将它们合并成一个更大的空闲内存块。

`malloc` 和 `free` 仅分配和释放内存，而不对内存内容进行初始化。在 C++ 中，`new` 和 `delete` 操作符不仅负责内存分配和释放，还负责对象的构造和析构。



### 12. 被free回收了的内存是否立刻还给操作系统？

当使用 `free` 函数回收内存时，这些内存是否立刻还给操作系统取决于实现和操作系统。C 库实现会在内部维护一个内存池，将回收的内存加入内存池以供将来分配。

在某些情况下，内存池可能会变得非常大，C 库实现可以选择将部分内存归还给操作系统。归还内存的策略取决于实现和操作系统，例如可能会基于内存使用量、空闲内存块的大小或空闲时间来决定。

`free` 函数主要目的是将内存归还给内部的内存池，以便在后续的内存分配请求（如 `malloc`、`calloc` 和 `realloc`）中重用。只有在特定条件下，内存才可能被归还给操作系统。



### 内存池
