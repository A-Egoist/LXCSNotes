# 点点互动-服务端开发

三道问答题

题目1 基础定时器

某游戏需要实现战场刷新机制：

*   每隔30秒刷新一波小怪(循环任务)
*   战斗开始后5分钟刷新boss(单次任务)
*   支持随时取消未触发的boss刷新

请根据以下要求进行作答：

1.   设计定时器节点的数据结构(包括关键字段)
2.   选择有序数组或最小堆实现定时器模块，说明选择原因以及时间复杂度
3.   实现添加定时器逻辑(也可以伪代码，需要处理时间戳排序)



题目2 高精度定时器

基于linux开发的战斗服务器中，会需要一些高精度定时器，要求：

1.   使用timerfd + epoll 实现高精度定时器(误差<1ms)
2.   定时事件和网络事件在同一线程处理
3.   支持动态添加/删除定时器

请根据以下要求，补全相关编码：

1.   补全关键函数：
     ```cpp
     int init_timer() {
         int tfd = timerfd_create(CLOCK_MONOTONIC, TFD_NONBLOCK);
         // 补全：设置30ms周期定时器(itimerspec结构体配置)
         // 补全：将tfd加入epoll实例(EPOLLIN事件
     }
     ```

2.   在epoll事件循环中处理定时器触发：
     ```cpp
     void event_loop() {
         while (true) {
             int n = epoll_wait(epfd, events, MAX_EVENTS, -1);
             for (int i = 0; i < n; ++ i) {
                 if (events[i].data.fd == tfd) {
                     // 补全：读取 tfd 计数避免多次触发
                     // 补全：执行所有到期定时器回调
                 }
             }
         }
     }
     ```

     

题目3 定时器性能优化

当定时器数量超过10万时，传统最小堆插入效率下降。现有方案：

1.   时间轮(Timing Wheel)分层：秒级轮(512槽)+毫秒级轮(1024槽)
2.   惰性删除：标记取消的定时器，执行时跳过

请根据以下要求进行作答：

1.   解决“秒级轮定时器到期后迁移至毫秒级轮”的伪代码
2.   设计取消定时器的数据结构(要求O(1)时间复杂度删除)
3.   计算时间轮定位槽位的哈希函数(输入：时间戳，输出：秒级槽位+毫秒级槽位)